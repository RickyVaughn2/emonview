<!doctype html>
    
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>EmonView</title>
        
        <link href="static/style.css" rel="stylesheet">
        
        <script type="text/javascript" src="static/jquery-1.9.0.min.js"></script>
        <script type="text/javascript" src="static/socket.io.min.js"></script>
        <script type="text/javascript" src="static/graph.js"></script>
        
        <script type="text/javascript" src="static/flot/jquery.flot.min.js"></script>
        <script type="text/javascript" src="static/flot/jquery.flot.time.min.js"></script>
    </head>

    <body>
    
        <div id="left-pane">
            <div class="block">
                <h3>EmonView</h3>
                <br>
                <div class="menu">
                    <div class="menu-item"><a href="#nodes">Nodes</a></div>
                    <div class="menu-item"><a href="#console">Console</a></div>
                    <div class="menu-item"><a href="#config">Config</a></div>
                    <div class="menu-item"><a href="#services">Services</a></div>
                </div>
                
                <div class="menu">
                    <div class="menu-item-heading">My Apps</div>
                    <div class="menu-item"><a href="#myelectric">My Electric</a></div>
                </div>
            </div>
        </div>


        <div id="right-pane">
            <div class="view" name="console">
                <div class="block">
                    <h3>Console</h3>
                    <pre id="log"><div  class="console-out"></div></pre>
                </div>
            </div>
                    
            <div class="view" name="config" style="display:none">
                <div class="block">
                    <h3>Config</h3>
                    <br>
                    <button id="saveconf">Save changes</button><br><br>
                    <div class="bound-config">
                         <textarea id="emonhubconf" class="boxsizingborder"></textarea>
                    </div>
                </div>
            </div>
                
            <div class="view" name="nodes" style="display:none; height:100%">

                <div class="test2">
                    <div class="test"><h3>Nodes</h3></div>
                    <ul id="nodelist" class="list"></ul>
                </div>
                
                <div class="bound-variables">
                    
                    <div class="margin-block" style="width:350px">
                        <div class="test">
                            <h3>Variables</h3>
                        </div>
                        <table class="table" id="variable-table"></table>
                    </div>
                    
                    <div style="margin-left:350px">
                        <div class="test">
                            <h3>View</h3>
                        </div>
                        <div style="padding:20px">
                            <div id="placeholder" style="height:400px"></div>
                        </div>    
                    </div>
                </div>
            </div>
            
            <div class="view" name="services" style="display:none">
                <div class="block">
                    <h3>Services</h3>
                    
                    <br>
                    
                    <table class="table">
                    <tr>
                    <th>Service name</th>
                    <th>Status</th>
                    <th>Action</th>
                    </tr>
                    <tr>
                    <td>emonview</td>
                    <td class="service-status" service="emonview">?</td>
                        <td service="emonview">
                            <button class="service-action" action="start">start</button>
                            <button class="service-action" action="stop">stop</button>
                            <button class="service-action" action="restart">restart</button>
                            <button class="service-action" action="status">status</button>
                        </td>
                    </tr>
                    <tr>
                    <td>rfmpi2mqtt</td>
                    <td class="service-status" service="rfmpi2mqtt">?</td>
                       <td service="rfmpi2mqtt">
                            <button class="service-action" action="start">start</button>
                            <button class="service-action" action="stop">stop</button>
                            <button class="service-action" action="restart">restart</button>
                            <button class="service-action" action="status">status</button>
                        </td>
                    </tr>
                    </table>
                    
                </div>
            </div>
            
            
            <div class="view" name="myelectric" style="display:none">
                <div class="block">
                    <h3>POWER NOW:</h3>
                    <div class="myelectric-powervalue" style="font-family:arial"><span key="rx/lab/temperature/value">0</span>W</div>
                    <div class="myelectric-kwhvalue">USE TODAY: <b><span key="rx/lab/battery/value">0</span> kWh</b></div>
                </div>
            </div>
            
        </div>
        
    </body>

</html>

<script type="text/javascript" charset="utf-8">

    var appstart = (new Date()).getTime();
    var viskey = "";
    var loadedhistoric = "";

    graph.width = 600;
    graph.height = 400;
    
    var options = {
        lines: { show:true, fill: false },
        points: { show:false},
        xaxis: { mode: "time", timezone: "browser", minTickSize: [1, "second"]}, // 
        // yaxis: { min: 0 },
        grid: {hoverable: true, clickable: true},
        selection: { mode: "x" }
    };

    var view = "console";
    var rxkeys = {
        "rx/LabEmonTx/MessageNumber/value":0,
        "rx/LabEmonTx/PowerCT1/value":0
    
    };
    var nodes = {};
    var data = {};
    var graphdata = [];
    
    for (key in rxkeys) set_key(key,rxkeys[key]);
    
    $(document).ready(function(){
        view = (window.location.hash).substring(1);
        show_view();
        
        namespace = '/test'; // change to an empty string to use the global namespace

        // the socket.io documentation recommends sending an explicit package upon connection
        // this is specially important when using the global namespace
        var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
        socket.on('connect', function() {
            socket.emit('my event', {data: 'I\'m connected!'});
        });

        // event handler for server sent data
        // the data is displayed in the "Received" section of the page
        socket.on('my response', function(msg) {
        
            
            if (msg.topic=="log") {
                $('.console-out').append(msg.payload+"\n");
            } else if (msg.topic=="service-log") {
                var parts = msg.payload.split("/");
                var service = parts[0];
                var status = parts[1];
                console.log(msg.payload);
                $('.service-status[service="'+service+'"]').html(status);
            } else {
                $('.console-out').append(msg.topic+" "+msg.payload+"\n");
                var key = msg.topic; //.replace(/\//g,".");
                var value = msg.payload;
                set_key(key,value);
                
                if (data[key]==undefined) {
                    data[key] = [];
                } else {
                    var time = parseInt((new Date()).getTime());
                    data[key].push([time,value*1]);
                }
                
                if (key==viskey) {
                    //graph.draw("graph",[data[key]]);
                    plot();
                }
                
            }
            
            var h = parseInt($('#log')[0].scrollHeight);
            $('#log').scrollTop(h);
        });
        
        
        
        // socket.emit('my event', {data: $('#emit_data').val()});
        
        $.ajax({ url: "conf", cache: false, success: function(data){
            $("#emonhubconf").val(data);
        }});
        
        $("#saveconf").click(function(){
            $.ajax({ type:'POST', url: "conf", contentType: "text/plain", data: $("#emonhubconf").val() });
        });
        
        $(".service-action").click(function(){
            var service = $(this).parent().attr("service");
            var action = $(this).attr("action");
            $.ajax({ type:'POST', url: "service/"+service+"/"+action});
        });
        
        $(window).on('hashchange', function() {
            view = (window.location.hash).substring(1);
            show_view();
        });
        
        
        $("body").on("click",".vis",function(){
            viskey = $(this).attr('viskey');
            console.log(viskey);
            plot();
            history_graph(viskey)
        });
        
    });
    
    function show_view(){
        $(".view").hide();
        
        if (view.indexOf("nodes/")==0){
            $(".view[name=nodes]").show();
            var parts = view.split("/");
            var nodename = parts[1];
            $("#variable-table tbody").hide();
            $("[node="+nodename+"]").show();
            $('li').removeClass("selected");
            $('a[href="#nodes/'+nodename+'"]').parent().addClass("selected");
            
            if (parts[2]!=undefined){
                var varname = parts[2];
                viskey = "rx/"+nodename+"/"+varname+"/value";
                plot();
            }
        } else {
            $(".view[name="+view+"]").show();
        }
    }
    
    function set_key(key,value)
    {
        var keyparts = key.split("/");
        var nodename = keyparts[1]; var varname = keyparts[2];
        
        if (nodes[nodename]==undefined) {
            nodes[nodename] = [];
            
            $("#nodelist").append('<li><a href="#nodes/'+nodename+'">'+nodename+'</a></li>');
            $("#variable-table").append("<tbody node='"+nodename+"' style='display:none'></tbody>");
        }
        
        if (nodes[nodename].indexOf(varname)==-1) {
            nodes[nodename].push(varname);  
            
            var valuekey = "rx/"+nodename+"/"+varname+"/value";
            var unitskey = "rx/"+nodename+"/"+varname+"/units";
            var out = "<tr class='vis clickable' viskey='"+valuekey+"'><td>"+varname+"</td><td><span key='"+valuekey+"'></span> <span key='"+unitskey+"'></span></td></tr>";
            $('tbody[node="'+nodename+'"]').append(out);
        }
        
        $('[key="'+key+'"]').html(value);
    }
    
    function history_graph(viskey)
    {
        var keyparts = viskey.split("/");
        var nodename = keyparts[1]; var varname = keyparts[2];
        
        // end = (new Date()).getTime();
        end = appstart;
        start = end - 3600*1000;
        interval = 10;
        
        $.ajax({
            url: 'data/'+nodename+'/'+varname+'?start='+start+'&end='+end+'&interval='+interval,
            dataType: 'json',
            async: false,
            success: function(result) { 
                graphdata = result;
                graphdata.push(data[viskey][0]);
                loadedhistoric = viskey;
                plot();
                
            }
        });
    }
    
    function plot()
    {
        var series = [];
        if (loadedhistoric==viskey) series.push({data:graphdata, color:"#edc241"});
        series.push({data:data[viskey], color:"#f1a748"});
    
        $.plot("#placeholder",series,options);
    }
    
        
</script>
